###
@host = http://localhost:5289
@contentType = application/json

# ==============================================================================
# 1. AUTHENTICATION (Get Tokens for Everyone)
# ==============================================================================

### 1.1 Login Customer (Sara)
# We will use this token to create the booking.
# @name loginCustomer
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "majed@gmail.com",
    "password": "Password@123"
}
###
@tokenCustomer = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItMiIsInVuaXF1ZV9uYW1lIjoiU2FyYSBBaG1hZCIsImVtYWlsIjoic2FyYUBleGFtcGxlLmNvbSIsInJvbGUiOiJDdXN0b21lciIsIm5iZiI6MTc2NDUzMDExOCwiZXhwIjoxNzY0NjE2NTE3LCJpYXQiOjE3NjQ1MzAxMTgsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.63RHyCNH2vCz_GnenEpQkBCGyYjbRZ2mDH-Krj8hNKM

### 1.2 Login Provider 1 (Rashed - -1)
# @name loginPro1
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "rashed@example.com",
    "password": "Password"
}
###
@tokenPro1 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItMSIsInVuaXF1ZV9uYW1lIjoiUmFzaGVkIEdoYW5lbSIsImVtYWlsIjoicmFzaGVkQGV4YW1wbGUuY29tIiwicm9sZSI6IlNlcnZpY2VQcm92aWRlciIsIm5iZiI6MTc2NDUzMDE0NSwiZXhwIjoxNzY0NjE2NTQ1LCJpYXQiOjE3NjQ1MzAxNDUsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.uK6vXbP_1j1z3FceCDyYqGQiVElt5HNGjbHHgr9vd9s

### 1.3 Login Provider 2 (Hothifah - -4)
# @name loginPro2
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "hothifah@example.com",
    "password": "Password"
}
###
@tokenPro2 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItNCIsInVuaXF1ZV9uYW1lIjoiSG90aGlmYWggTWFlbiIsImVtYWlsIjoiaG90aGlmYWhAZXhhbXBsZS5jb20iLCJyb2xlIjoiU2VydmljZVByb3ZpZGVyIiwibmJmIjoxNzY0NTMwMTcwLCJleHAiOjE3NjQ2MTY1NzAsImlhdCI6MTc2NDUzMDE3MCwiaXNzIjoiQWplZXJCYWNrZW5kQVBJIiwiYXVkIjoiQWplZXJDbGllbnRzIn0.NrJtscD_4v6ryA3m9DxM3SOitHpH7YArRWWJJ_3Gzuo

### 1.4 Login Provider 3 (Saad - -5)
# @name loginPro3
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "saad@example.com",
    "password": "Password"
}
###
@tokenPro3 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItNSIsInVuaXF1ZV9uYW1lIjoiU2FhZCBKYmFyYWgiLCJlbWFpbCI6InNhYWRAZXhhbXBsZS5jb20iLCJyb2xlIjoiU2VydmljZVByb3ZpZGVyIiwibmJmIjoxNzY1NjMyMzU2LCJleHAiOjE3NjU3MTg3NTYsImlhdCI6MTc2NTYzMjM1NiwiaXNzIjoiQWplZXJCYWNrZW5kQVBJIiwiYXVkIjoiQWplZXJDbGllbnRzIn0.sN6gYAo35JETDj1S9QYDQ9dTFOYT5vfGL87VneS2-_Y


# ==============================================================================
# 2. CUSTOMER JOURNEY: CREATE BOOKING
# ==============================================================================

### 2.1 Get Service Areas (To find "Abdoun")
# Expect: A list of cities and areas. We want Area ID -1 (Abdoun).
GET {{host}}/api/service-areas
Authorization: Bearer {{tokenCustomer}}

### 2.2 Get Services (To find "Leak Repair")
# Expect: List of services. We want Service ID -1.
GET {{host}}/api/services?categoryId=-1
Authorization: Bearer {{tokenCustomer}}

### 2.3 Create Booking (Leak Repair in Abdoun)
# Scenario: 
# - Service: -1 (Leak Repair)
# - Area: -1 (Abdoun) -> Covered by Rashed, Hothifah, and Saad.
# - Date: A Monday (e.g., Dec 1, 2025) -> All are available.
# Result: The system will randomly pick one of the 3 providers.
# @name createBooking
POST {{host}}/api/bookings
Authorization: Bearer {{tokenCustomer}}
Content-Type: multipart/form-data; boundary=boundary123

--boundary123
Content-Disposition: form-data; name="ServiceIds"

-1
--boundary123
Content-Disposition: form-data; name="ServiceAreaId"

-1
--boundary123
Content-Disposition: form-data; name="ScheduledDate"

2025-12-8T10:00:00
--boundary123
Content-Disposition: form-data; name="Address"

Abdoun Circle, Villa 5
--boundary123
Content-Disposition: form-data; name="Latitude"

31.9500
--boundary123
Content-Disposition: form-data; name="Longitude"

35.9333
--boundary123
Content-Disposition: form-data; name="Notes"

Urgent leak in the main bathroom.
--boundary123--
###
Content-Disposition: form-data; name="Attachments"; filename="test-image.jpg"
Content-Type: image/jpeg

< ./test-image.jpg
--boundary123--
###
@bookingId = 3004


# ==============================================================================
# 3. PROVIDER JOURNEY: CHECK & REJECT (Re-assignment Test)
# ==============================================================================

# -------------------------------------------------------
# MANUAL STEP:
# Since assignment is random, check your Database or the logs 
# to see which provider got the job (Rashed, Hothifah, or Saad).
# Use the corresponding Token below.
# -------------------------------------------------------

### 3.1 Get Bookings (As Provider 1 - Rashed)
# Check if Rashed got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro1}}

### 3.2 Get Bookings (As Provider 2 - Hothifah)
# Check if Hothifah got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro2}}

### 3.3 Get Bookings (As Provider 3 - Saad)
# Check if Saad got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro3}}

### 3.4 REJECT BOOKING (As the Assigned Provider)
# REPLACE {{tokenPro1}} with the token of the provider who ACTUALLY got the job.
# Result: The booking status stays 'Pending', but ServiceProviderId changes to one of the others.
PUT {{host}}/api/bookings/{{bookingId}}/reject
Authorization: Bearer {{tokenPro1}}


# ==============================================================================
# 4. PROVIDER JOURNEY: ACCEPT & COMPLETE
# ==============================================================================

# -------------------------------------------------------
# MANUAL STEP:
# Check who the NEW provider is (it should be different from the one who rejected).
# Use their token below.
# -------------------------------------------------------

### 4.1 Accept Booking (As the New Provider)
# Result: Status changes to 'Active'.
PUT {{host}}/api/bookings/{{bookingId}}/accept
Authorization: Bearer {{tokenPro3}}

### 4.2 Complete Booking (As the New Provider)
# Result: Status changes to 'Completed'.
PUT {{host}}/api/bookings/{{bookingId}}/complete
Authorization: Bearer {{tokenPro3}}


# ==============================================================================
# 5. CUSTOMER JOURNEY: REVIEW
# ==============================================================================

### 5.1 Leave a Review (As Customer Sara)
# Only possible because status is now 'Completed'.
POST {{host}}/api/reviews
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "bookingId": 2,
    "rating": 5,
    "comment": "Excellent service! The replacement provider was very fast."
}

### 5.2 Verify Review & Provider Rating Update
# Check the booking details to see the review attached.
GET {{host}}/api/bookings/{{bookingId}}
Authorization: Bearer {{tokenCustomer}}

# ==============================================================================
# 1. SETUP: REGISTER A NEW CUSTOMER (User to be upgraded)
# ==============================================================================

### 1.1 Register Jane Doe (Starts as Customer)
# This token will be used to call the /providers/register endpoint.
# @name registerJane
POST {{host}}/api/auth/register
Content-Type: {{contentType}}

{
    "name": "Majed Ahmed",
    "email": "majed@gmail.com",
    "phone": "0790001100",
    "password": "Password@123"
}
###
@tokenCustomer = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIyIiwidW5pcXVlX25hbWUiOiJNYWplZCBBaG1lZCIsImVtYWlsIjoibWFqZWRAZ21haWwuY29tIiwicm9sZSI6IlNlcnZpY2VQcm92aWRlciIsIm5iZiI6MTc2NDg3NzE4NCwiZXhwIjoxNzY0OTYzNTg0LCJpYXQiOjE3NjQ4NzcxODQsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.LOahaPcW29ZWtv09WuKASiR0YM2UhgkoMuz8tW_pOrs


### 1.2 Verify Jane's Initial Role (Should see "Customer")
GET {{host}}/api/auth/test-auth
Authorization: Bearer {{tokenCustomer}}

# ==============================================================================
# 2. PROVIDER REGISTRATION (Upgrade User Role)
# ==============================================================================

### 2.1 Attempt to Become a Provider (Jane)
# Jane will register to provide Plumbing (Services -1, -2, -3) in Abdoun (-1) and Jebel Al-Weibdeh (-2).
# Schedules: Monday 8:00 - 12:00 AND Monday 13:00 - 17:00 (Testing Overlap Validator and multiple slots).
# @name becomeProvider
POST {{host}}/api/serviceproviders/register
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "serviceIds": [ -1, -2, -3 ],
    "serviceAreaIds": [ -1, -3 ],
    "schedules": [
        {
            "dayOfWeek": "Saturday",
            "startTime": "08:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Sunday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Monday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Tuesday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Wednesday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Thursday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Friday",
            "startTime": "8:00:00",
            "endTime": "20:00:00"
        }
    ]
}
###
@tokenProvider = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIyIiwidW5pcXVlX25hbWUiOiJNYWplZCBBaG1lZCIsImVtYWlsIjoibWFqZWRAZ21haWwuY29tIiwicm9sZSI6IlNlcnZpY2VQcm92aWRlciIsIm5iZiI6MTc2NDg2OTIwNiwiZXhwIjoxNzY0OTU1NjA2LCJpYXQiOjE3NjQ4NjkyMDYsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.6W22KQf8xvM7d3yrwm7yYKWYby-HLZlmL6Unzg58MuI
### 2.2 Verify New Role (Should see "ServiceProvider")
# Using the NEW token from the provider registration response.
GET {{host}}/api/auth/test-auth
Authorization: Bearer {{tokenCustomer}}


# ==============================================================================
# 3. VALIDATION FAILURE TESTS
# ==============================================================================

### 3.1 Fail: Duplicate Registration (Jane is already a provider)
# Expected: 400 Bad Request / Exception message: "User is already registered as a service provider."
POST {{host}}/api/providers/register
Authorization: Bearer {{tokenProvider}}
Content-Type: {{contentType}}

{
    "bio": "Should fail.",
    "serviceIds": [ -1 ],
    "serviceAreaIds": [ -1 ],
    "schedules": [ { "dayOfWeek": "Monday", "startTime": "09:00:00", "endTime": "17:00:00" } ]
}


### 3.2 Fail: Schedule Overlap
# Monday slot 1 (9:00 - 11:00) overlaps with slot 2 (10:00 - 12:00)
# Expected: 400 Bad Request / Validation Error: "Your schedule contains overlapping time slots..."
POST {{host}}/api/providers/register
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "bio": "Test Overlap",
    "serviceIds": [ -1 ],
    "serviceAreaIds": [ -1 ],
    "schedules": [
        {
            "dayOfWeek": "Tuesday",
            "startTime": "09:00:00",
            "endTime": "11:00:00"
        },
        {
            "dayOfWeek": "Tuesday",
            "startTime": "10:00:00",
            "endTime": "12:00:00"
        }
    ]
}

###
# Get provider info
GET {{host}}/api/serviceProviders/my-profile
Authorization: Bearer {{tokenPro1}}

### 3. Update Profile
# Change Bio
# Services: Keep -1 (Leak Repair), Add -3 (Deep Cleaning), Remove -2 (Pipe Installation)
# Areas: Keep -1 (Khalda)
# Schedule: Change to ONLY Friday 10-4
PUT {{host}}/api/serviceProviders/profile
Authorization: Bearer {{tokenPro1}}
Content-Type: {{contentType}}

{
    "bio": "Updated Bio: Expert Plumber and now doing Deep Cleaning!",
    "serviceIds": [ -1, -2, -3],
    "serviceAreaIds": [ -1, -2, -3 ],
    "schedules": [
        {
            "dayOfWeek": "Monday",
            "startTime": "10:00:00",
            "endTime": "16:00:00"
        },
        {
            "dayOfWeek": "Monday",
            "startTime": "17:00:00",
            "endTime": "20:00:00"
        },
        {
            "dayOfWeek": "Thursday",
            "startTime": "10:00:00",
            "endTime": "16:00:00"
        }
    ]
}

### 4. Verify Update
# Check if the new services and schedule appear
GET {{host}}/api/serviceProviders/my-profile
Authorization: Bearer {{tokenPro1}}


# ==============================================================================
# 2. UPDATE PROFILE INFO (Multipart)
# ==============================================================================

### 2.1 Update Name, Phone, and Picture
# We are changing name to "Sara Updated" and phone to "0799999999".
# We are uploading a profile picture.
# Response: Should return a NEW Token with the updated Name/Picture claims.
# @name updateProfile
PUT {{host}}/api/users/profile
Authorization: Bearer {{tokenCustomer}}
Content-Type: multipart/form-data; boundary=boundaryProfile

--boundaryProfile
Content-Disposition: form-data; name="Name"

Majed Jamal
--boundaryProfile
Content-Disposition: form-data; name="Phone"

0799999999
--boundaryProfile
Content-Disposition: form-data; name="ProfileImage"; filename="test.jpg"
Content-Type: image/jpeg

< ./test.jpg
--boundaryProfile--

# Capture the NEW token returned by the update (it might have updated claims)
@newToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIyIiwidW5pcXVlX25hbWUiOiJNYWplZCBKYW1hbCIsImVtYWlsIjoibWFqZWRAZ21haWwuY29tIiwicm9sZSI6IlNlcnZpY2VQcm92aWRlciIsIm5iZiI6MTc2NDg3ODA0MCwiZXhwIjoxNzY0OTY0NDQwLCJpYXQiOjE3NjQ4NzgwNDAsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.5xuA5aoP3wY1tb-SEIM2_VgCvgtP28JsB3EDEb0sD2U


### 2.2 Verify Update (Check Auth endpoint)
# Using the NEW token, check if the name is updated in the claims/response.
GET {{host}}/api/auth/test-auth
Authorization: Bearer {{newToken}}


# ==============================================================================
# 3. CHANGE PASSWORD
# ==============================================================================

### 3.1 Fail: Wrong Current Password
# Trying to change password with incorrect old password.
# Expected: 400 Bad Request ("Incorrect current password")
PUT {{host}}/api/users/change-password
Authorization: Bearer {{newToken}}
Content-Type: {{contentType}}

{
    "currentPassword": "WrongPassword",
    "newPassword": "NewStrongPassword123"
}

### 3.2 Success: Change Password
# Changing from "Password" to "NewStrongPassword123".
PUT {{host}}/api/users/change-password
Authorization: Bearer {{newToken}}
Content-Type: {{contentType}}

{
    "currentPassword": "NewStrongPassword123",
    "newPassword": "Password@123"
}


# ==============================================================================
# 4. VERIFY LOGIN WITH NEW PASSWORD
# ==============================================================================

### 4.1 Fail: Login with OLD Password
# Expected: 401 Unauthorized
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "majed@gmail.com",
    "password": "Password@123"
}

### 4.2 Success: Login with NEW Password
# Expected: 200 OK
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "sara@example.com",
    "password": "NewStrongPassword123"
}