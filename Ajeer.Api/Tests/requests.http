###
@host = http://localhost:5289
@contentType = application/json

# ==============================================================================
# 1. AUTHENTICATION (Get Tokens for Everyone)
# ==============================================================================

### 1.1 Login Customer (Sara)
# We will use this token to create the booking.
# @name loginCustomer
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "sara@example.com",
    "password": "Password"
}
###
@tokenCustomer = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItMiIsInVuaXF1ZV9uYW1lIjoiU2FyYSBBaG1hZCIsImVtYWlsIjoic2FyYUBleGFtcGxlLmNvbSIsInJvbGUiOiJDdXN0b21lciIsIm5iZiI6MTc2NDUzMDExOCwiZXhwIjoxNzY0NjE2NTE3LCJpYXQiOjE3NjQ1MzAxMTgsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.63RHyCNH2vCz_GnenEpQkBCGyYjbRZ2mDH-Krj8hNKM

### 1.2 Login Provider 1 (Rashed - -1)
# @name loginPro1
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "rashed@example.com",
    "password": "Password"
}
###
@tokenPro1 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItMSIsInVuaXF1ZV9uYW1lIjoiUmFzaGVkIEdoYW5lbSIsImVtYWlsIjoicmFzaGVkQGV4YW1wbGUuY29tIiwicm9sZSI6IlNlcnZpY2VQcm92aWRlciIsIm5iZiI6MTc2NDUzMDE0NSwiZXhwIjoxNzY0NjE2NTQ1LCJpYXQiOjE3NjQ1MzAxNDUsImlzcyI6IkFqZWVyQmFja2VuZEFQSSIsImF1ZCI6IkFqZWVyQ2xpZW50cyJ9.uK6vXbP_1j1z3FceCDyYqGQiVElt5HNGjbHHgr9vd9s

### 1.3 Login Provider 2 (Hothifah - -4)
# @name loginPro2
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "hothifah@example.com",
    "password": "Password"
}
###
@tokenPro2 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItNCIsInVuaXF1ZV9uYW1lIjoiSG90aGlmYWggTWFlbiIsImVtYWlsIjoiaG90aGlmYWhAZXhhbXBsZS5jb20iLCJyb2xlIjoiU2VydmljZVByb3ZpZGVyIiwibmJmIjoxNzY0NTMwMTcwLCJleHAiOjE3NjQ2MTY1NzAsImlhdCI6MTc2NDUzMDE3MCwiaXNzIjoiQWplZXJCYWNrZW5kQVBJIiwiYXVkIjoiQWplZXJDbGllbnRzIn0.NrJtscD_4v6ryA3m9DxM3SOitHpH7YArRWWJJ_3Gzuo

### 1.4 Login Provider 3 (Saad - -5)
# @name loginPro3
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
    "identifier": "saad@example.com",
    "password": "Password"
}
###
@tokenPro3 = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiItNSIsInVuaXF1ZV9uYW1lIjoiU2FhZCBKYmFyYWgiLCJlbWFpbCI6InNhYWRAZXhhbXBsZS5jb20iLCJyb2xlIjoiU2VydmljZVByb3ZpZGVyIiwibmJmIjoxNzY0NTMwMjAwLCJleHAiOjE3NjQ2MTY2MDAsImlhdCI6MTc2NDUzMDIwMCwiaXNzIjoiQWplZXJCYWNrZW5kQVBJIiwiYXVkIjoiQWplZXJDbGllbnRzIn0.-Ki4WNILC5-L-PXpdT7ABjJOCvaab2UwBp2EEE2Rnl0


# ==============================================================================
# 2. CUSTOMER JOURNEY: CREATE BOOKING
# ==============================================================================

### 2.1 Get Service Areas (To find "Abdoun")
# Expect: A list of cities and areas. We want Area ID -1 (Abdoun).
GET {{host}}/api/service-areas
Authorization: Bearer {{tokenCustomer}}

### 2.2 Get Services (To find "Leak Repair")
# Expect: List of services. We want Service ID -1.
GET {{host}}/api/services?categoryId=-1
Authorization: Bearer {{tokenCustomer}}

### 2.3 Create Booking (Leak Repair in Abdoun)
# Scenario: 
# - Service: -1 (Leak Repair)
# - Area: -1 (Abdoun) -> Covered by Rashed, Hothifah, and Saad.
# - Date: A Monday (e.g., Dec 1, 2025) -> All are available.
# Result: The system will randomly pick one of the 3 providers.
# @name createBooking
POST {{host}}/api/bookings
Authorization: Bearer {{tokenCustomer}}
Content-Type: multipart/form-data; boundary=boundary123

--boundary123
Content-Disposition: form-data; name="ServiceIds"

-1
--boundary123
Content-Disposition: form-data; name="ServiceAreaId"

-1
--boundary123
Content-Disposition: form-data; name="ScheduledDate"

2025-12-8T10:00:00
--boundary123
Content-Disposition: form-data; name="Address"

Abdoun Circle, Villa 5
--boundary123
Content-Disposition: form-data; name="Latitude"

31.9500
--boundary123
Content-Disposition: form-data; name="Longitude"

35.9333
--boundary123
Content-Disposition: form-data; name="Notes"

Urgent leak in the main bathroom.
--boundary123
Content-Disposition: form-data; name="Attachments"; filename="test-image.jpg"
Content-Type: image/jpeg

< ./test-image.jpg
--boundary123--
###
@bookingId = 1


# ==============================================================================
# 3. PROVIDER JOURNEY: CHECK & REJECT (Re-assignment Test)
# ==============================================================================

# -------------------------------------------------------
# MANUAL STEP:
# Since assignment is random, check your Database or the logs 
# to see which provider got the job (Rashed, Hothifah, or Saad).
# Use the corresponding Token below.
# -------------------------------------------------------

### 3.1 Get Bookings (As Provider 1 - Rashed)
# Check if Rashed got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro1}}

### 3.2 Get Bookings (As Provider 2 - Hothifah)
# Check if Hothifah got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro2}}

### 3.3 Get Bookings (As Provider 3 - Saad)
# Check if Saad got it.
GET {{host}}/api/bookings?role=ServiceProvider
Authorization: Bearer {{tokenPro3}}

### 3.4 REJECT BOOKING (As the Assigned Provider)
# REPLACE {{tokenPro1}} with the token of the provider who ACTUALLY got the job.
# Result: The booking status stays 'Pending', but ServiceProviderId changes to one of the others.
PUT {{host}}/api/bookings/{{bookingId}}/reject
Authorization: Bearer {{tokenPro1}}


# ==============================================================================
# 4. PROVIDER JOURNEY: ACCEPT & COMPLETE
# ==============================================================================

# -------------------------------------------------------
# MANUAL STEP:
# Check who the NEW provider is (it should be different from the one who rejected).
# Use their token below.
# -------------------------------------------------------

### 4.1 Accept Booking (As the New Provider)
# Result: Status changes to 'Active'.
PUT {{host}}/api/bookings/{{bookingId}}/accept
Authorization: Bearer {{tokenPro3}}

### 4.2 Complete Booking (As the New Provider)
# Result: Status changes to 'Completed'.
PUT {{host}}/api/bookings/{{bookingId}}/complete
Authorization: Bearer {{tokenPro3}}


# ==============================================================================
# 5. CUSTOMER JOURNEY: REVIEW
# ==============================================================================

### 5.1 Leave a Review (As Customer Sara)
# Only possible because status is now 'Completed'.
POST {{host}}/api/reviews
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "bookingId": 1,
    "rating": 5,
    "comment": "Excellent service! The replacement provider was very fast."
}

### 5.2 Verify Review & Provider Rating Update
# Check the booking details to see the review attached.
GET {{host}}/api/bookings/{{bookingId}}
Authorization: Bearer {{tokenCustomer}}

# ==============================================================================
# 1. SETUP: REGISTER A NEW CUSTOMER (User to be upgraded)
# ==============================================================================

### 1.1 Register Jane Doe (Starts as Customer)
# This token will be used to call the /providers/register endpoint.
# @name registerJane
POST {{host}}/api/auth/register
Content-Type: {{contentType}}

{
    "name": "Mohammed Sami",
    "email": "mohammed@gmail.com",
    "phone": "0790001000",
    "password": "Password@123"
}
###
@tokenCustomer = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIxIiwidW5pcXVlX25hbWUiOiJNb2hhbW1lZCBTYW1pIiwiZW1haWwiOiJtb2hhbW1lZEBnbWFpbC5jb20iLCJyb2xlIjoiQ3VzdG9tZXIiLCJuYmYiOjE3NjQ3MDQwNTYsImV4cCI6MTc2NDc5MDQ1NiwiaWF0IjoxNzY0NzA0MDU2LCJpc3MiOiJBamVlckJhY2tlbmRBUEkiLCJhdWQiOiJBamVlckNsaWVudHMifQ.oKCAjv5MzDEhA3rVj3jpjEq5uIBYpuQJYgeKNyN396M
@userId = 1


### 1.2 Verify Jane's Initial Role (Should see "Customer")
GET {{host}}/api/auth/test-auth
Authorization: Bearer {{tokenCustomer}}

# ==============================================================================
# 2. PROVIDER REGISTRATION (Upgrade User Role)
# ==============================================================================

### 2.1 Attempt to Become a Provider (Jane)
# Jane will register to provide Plumbing (Services -1, -2, -3) in Abdoun (-1) and Jebel Al-Weibdeh (-2).
# Schedules: Monday 8:00 - 12:00 AND Monday 13:00 - 17:00 (Testing Overlap Validator and multiple slots).
# @name becomeProvider
POST {{host}}/api/serviceproviders/register
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "serviceIds": [ -1, -2, -3 ],
    "serviceAreaIds": [ -1, -2 ],
    "schedules": [
        {
            "dayOfWeek": "Monday",
            "startTime": "08:00:00",
            "endTime": "12:00:00"
        },
        {
            "dayOfWeek": "Monday",
            "startTime": "13:00:00",
            "endTime": "17:00:00"
        },
        {
            "dayOfWeek": "Wednesday",
            "startTime": "10:00:00",
            "endTime": "16:00:00"
        }
    ]
}
###
@tokenProvider = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIxIiwidW5pcXVlX25hbWUiOiJNb2hhbW1lZCBTYW1pIiwiZW1haWwiOiJtb2hhbW1lZEBnbWFpbC5jb20iLCJyb2xlIjoiU2VydmljZVByb3ZpZGVyIiwibmJmIjoxNzY0NzA0Mjk1LCJleHAiOjE3NjQ3OTA2OTUsImlhdCI6MTc2NDcwNDI5NSwiaXNzIjoiQWplZXJCYWNrZW5kQVBJIiwiYXVkIjoiQWplZXJDbGllbnRzIn0.jY-oNIQ6Lu3fzvO43M6ulbhCag5Trm03yGayrvGtQp4


### 2.2 Verify New Role (Should see "ServiceProvider")
# Using the NEW token from the provider registration response.
GET {{host}}/api/auth/test-auth
Authorization: Bearer {{tokenProvider}}


# ==============================================================================
# 3. VALIDATION FAILURE TESTS
# ==============================================================================

### 3.1 Fail: Duplicate Registration (Jane is already a provider)
# Expected: 400 Bad Request / Exception message: "User is already registered as a service provider."
POST {{host}}/api/providers/register
Authorization: Bearer {{tokenProvider}}
Content-Type: {{contentType}}

{
    "bio": "Should fail.",
    "serviceIds": [ -1 ],
    "serviceAreaIds": [ -1 ],
    "schedules": [ { "dayOfWeek": "Monday", "startTime": "09:00:00", "endTime": "17:00:00" } ]
}


### 3.2 Fail: Schedule Overlap
# Monday slot 1 (9:00 - 11:00) overlaps with slot 2 (10:00 - 12:00)
# Expected: 400 Bad Request / Validation Error: "Your schedule contains overlapping time slots..."
POST {{host}}/api/providers/register
Authorization: Bearer {{tokenCustomer}}
Content-Type: {{contentType}}

{
    "bio": "Test Overlap",
    "serviceIds": [ -1 ],
    "serviceAreaIds": [ -1 ],
    "schedules": [
        {
            "dayOfWeek": "Tuesday",
            "startTime": "09:00:00",
            "endTime": "11:00:00"
        },
        {
            "dayOfWeek": "Tuesday",
            "startTime": "10:00:00",
            "endTime": "12:00:00"
        }
    ]
}